<!DOCTYPE html>
<html>

<head>
    <title>Data Analysis</title>
</head>
<h1>Test JavaScript-DOM Interactions</h1

<body>
    <input type="file" id="fileInput">
    <script src="utils.js"></script>
    <script src="analysis-tools.js"></script>
    <script src="report-tools.js"></script>
    <script src="PapaParse-4.1.2/papaparse.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
</body>

<form action="#" id = "radioForm" onsubmit="parseCSV(this); return false">
    <input type="submit" action="parseCSV()">
</form>

<p id="demo"></p>
<form onsubmit="parseCSV(); return false">
    <script>
        var team = function() {};
        var level = function() {};
        var member = function() {};
        var action = function() {};
        var teams = [];

        function toggleSelectAll(checkboxName) {
            var checkboxArray = $("input[name=" + checkboxName + "]");
            if (checkboxArray[0].checked) {
                for (var i = 0; i < checkboxArray.length - 1; i++) {
                    checkboxArray[i + 1].checked = true;
                }
            } else {
                for (var j = 0; j < checkboxArray.length - 1; j++) {
                    checkboxArray[j + 1].checked = false;
                }
            }
        }

        function parseCSV(theForm) {
            teams = []; //Clear the teams array (which might be populated if we haven't
            //refreshed the page).
            document.getElementById("demo").innerHTML = "";
            var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv)$/;
            if (regex.test(fileInput.value)) {
                if (typeof(FileReader) != "undefined") {
                    var reader = new FileReader();
                    reader.onerror = function(err) {
                        console.log(err);
                    }
                    reader.onloadend = function(e) {
                        console.log("file loaded");
                        var obj = Papa.parse(e.target.result);
                        console.log("data parsed");
                        rowObjs = arrayToObjects(obj.data);
                        console.log("row objects created");
                        teams = makeTeams(rowObjs);
                        console.log("teams generated");
                        changes = analyze(rowObjs);
                        console.log("analysis complete");
                        var radioTable = document.createElement("table");
                        radioForm.appendChild(radioTable);
                        var headerRow = document.createElement("tr");
                        var checkBoxRow = document.createElement("tr");
                        radioTable.appendChild(headerRow);
                        var headerCell1 = document.createElement("th");
                        var headerCell2 = document.createElement("th");
                        var headerCell3 = document.createElement("th");
                        var headerCell4 = document.createElement("th");
                        headerCell1.innerHTML = "Teams";
                        headerCell2.innerHTML = "Levels";
                        headerCell3.innerHTML = "Actions";
                        headerCell4.innerHTML = "Summary Data";
                        headerRow.appendChild(headerCell1);
                        headerRow.appendChild(headerCell2);
                        headerRow.appendChild(headerCell3);
                        headerRow.appendChild(headerCell4);
                        var teamData = document.createElement("td");
                        var levelData = document.createElement("td");
                        var actionData = document.createElement("td");
                        var summaryData = document.createElement("td");
                        var typeStr = '<input type="checkbox"  ';
                        var IDStr = 'id="all-teams" ';
                        var onChangeStr= 'onchange="toggleSelectAll("team")">';
                        var labelStr = 'All teams<br>';
                        teamData.innerHTML = typeStr + onChangeStr + labelStr;
                        for (var i = 0; i<teams.length; i++) {
                          IDStr = 'id=team-' + teams[i].name + "> ";
                          labelStr = teams[i].name + "<br>";
                          teamData.innerHTML += typeStr + IDStr + labelStr;
                        }
                        IDStr = 'id="all-levels" ';
                        onChangeStr = 'onchange="toggleSelectAll("level")">';
                        labelStr = 'All levels<br>';
                        levelData.innerHTML = typeStr + onChangeStr + labelStr;
                        var labels = ["A","B","C","D"];
                        for (j= 0; j<labels.length; j++) {
                          IDStr = 'id=level-' + labels[j] + "> ";
                          labelStr = labels[j] + "<br>";
                          levelData.innerHTML += typeStr + IDStr + labelStr;
                        }
                        checkBoxRow.appendChild(teamData);
                        checkBoxRow.appendChild(levelData);
                        radioTable.appendChild(checkBoxRow);

                        reportResults(teams);
                        console.log("results reported");
                        reportSummary(teams);
                        console.log("summaries reported");
                        reportVoltageRegulator(teams);
                        console.log("voltage regulator reported");
                    }
                    reader.readAsText(fileInput.files[0]);
                } else {
                    alert("This browser does not support HTML5.");
                }
            } else {
                alert("Please upload a valid CSV file.");
            }
        }
    </script>
